name: CI

on:
    push:
        branches: [master, main]
    pull_request:
        branches: [master, main]

jobs:
    web-ci:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  submodules: false

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.12'

            - name: Show versions
              run: |
                  node -v
                  npm -v
                  python -V

            - name: Install Node deps (if package.json exists)
              id: node_install
              run: |
                  if [ -f package.json ]; then npm ci; else echo "no-pkg"; fi

            - name: Check pre-commit config
              id: pc
              shell: bash
              run: |
                  if [ -f .pre-commit-config.yaml ]; then
                    echo "present=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "present=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Install pre-commit
              if: ${{ steps.pc.outputs.present == 'true' }}
              run: |
                  python -m pip install --upgrade pip
                  pip install pre-commit

            - name: Run pre-commit
              if: ${{ steps.pc.outputs.present == 'true' }}
              run: pre-commit run --all-files --show-diff-on-failure

            - name: Skip pre-commit (config not found)
              if: ${{ steps.pc.outputs.present != 'true' }}
              run: echo ".pre-commit-config.yaml not found; skipping pre-commit"

            - name: Build/Test (no-op if absent)
              run: |
                  if [ -f Makefile ]; then make -n build || true; fi

            - name: ESLint
              run: |
                  if [ -f eslint.config.cjs ]; then
                    npx --yes eslint . --config eslint.config.cjs --max-warnings=0
                  elif [ -n "${{ hashFiles('eslint.config.*') }}" ]; then
                    npx --yes eslint . --max-warnings=0
                  else
                    echo "No ESLint config found; skipping"
                  fi

            - name: Stylelint
              run: |
                  if [ -f .stylelintrc.cjs ]; then
                    IGNORE_ARG=""
                    if [ -f .stylelintignore ]; then IGNORE_ARG="--ignore-path .stylelintignore"; fi
                    npx --yes stylelint "**/*.css" --config .stylelintrc.cjs $IGNORE_ARG --max-warnings=0 || true
                  elif [ -n "${{ hashFiles('.stylelintrc.*') }}" ]; then
                    npx --yes stylelint "**/*.css" --max-warnings=0 || true
                  else
                    echo "No Stylelint config found; skipping"
                  fi

            - name: Prettier check
              run: |
                  if [ -f .prettierrc.cjs ]; then
                    IGNORE_ARG=""
                    if [ -f .prettierignore ]; then IGNORE_ARG="--ignore-path .prettierignore"; fi
                    npx --yes prettier -c . --config .prettierrc.cjs $IGNORE_ARG
                  elif [ -n "${{ hashFiles('.prettierrc*') }}" ]; then
                    npx --yes prettier -c .
                  else
                    echo "No Prettier config found; skipping"
                  fi
